<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mihai Ion - L13: Conditional stats, outliers</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Mihai Ion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../research.html" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../teaching.html" rel="" target="" aria-current="page">
 <span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../CV/Mihai Ion CV.pdf" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">FIN 525</li><li class="breadcrumb-item"><a href="../../../teaching/FIN 525/lectures/lecture00_Jupyter_Basics.html">Lectures</a></li><li class="breadcrumb-item"><a href="../../../teaching/FIN 525/lectures/lecture13_wins_groupby_apply_transform.html">L13: Conditional stats, outliers</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Teaching</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">FIN 525</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture00_Jupyter_Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L00: Jupyter basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture01_Introduction_and_Setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L01: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture01_Jupyter_Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CELLS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture02_codeExecution_variables_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L02: Variables, types, operators</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture03_Data_Structures_Dot_Notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L03: Data structures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture04_Conditional_Statements_and_Iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L04: Conditionals, loops</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture05_Functions_and_Packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L05: Functions, packages</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture06_pandas_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L06: Pandas intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture07_data_input_output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L07: Pandas I/O</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture07_pandas_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas DataFrames</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture08_data_input_output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture08_filtering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L08: Pandas filtering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture09_data_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L09: Pandas data cleaning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture09_filtering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture10_data_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture10_merging_reshaping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L10: Merging, reshaping datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture11_Dates_Lags_Sorting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L11: Dates, lags, sorting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture11_merging_reshaping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture12_Dates_Lags_Sorting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Date formats: “pd.to_datetime()” and “dt.to_period()”</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture12_descriptive_stats_unconditional.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L12: Descriptive stats</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture13_wins_groupby_apply_transform.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">L13: Conditional stats, outliers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture14_conditional_stats_applied.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L14: Conditional stats applied</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture14_descriptive_stats_unconditional.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture15_regression_intro1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L15: Linear regression intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture15_wins_groupby_apply_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture16_conditional_stats_applied.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture16_regression_intro2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L16: Linear regression applications</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture17_regression_application_panel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L17: Panel regression intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture18_regression_intro1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture18_robust_panel_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L18: Robust panel regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture19_regression_application_timeseries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L19: Robust timeseries regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture19_regression_intro2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture20_backtesting_dataprep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L20: Backtesting - data prep</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture20_regression_application_panel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture21_robust_panel_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture21_sortvar_sumstats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L21: Backtesting - sumstats</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture22_portfolio_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L22: Backtesting -returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture22_regression_application_timeseries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture23_riskadjusted_ret.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L23: Backtesting - risk adjustment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture25_backtesting_dataprep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture26_sortvar_sumstats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture27_portfolio_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture28_riskadjusted_ret.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Raw returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 525/lectures/lecture9_data_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preliminaries</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">FIN 421</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/FL01_Introduction_and_Setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L_07_08_Portfolio_Theory_4_Optimal_Asset_Allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L01_Introduction_and_Setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L01: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L02_Foundations_1_Past_Returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L02: Analyzing past returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L03_Foundations_2_Future_Returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L03: Modeling future returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L04_Portfolio_Theory_1_Mechanics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L04: Portfolio theory intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L05_Portfolio_Theory_2_Optimal_Capital_Allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L05: Optimal capital allocation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L06_Portfolio_Theory_3_Tangency_Portfolios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L06: Tangency portfolios</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L07_08_Portfolio_Theory_4_Optimal_Asset_Allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L07_08: Optimal asset allocation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L078_Portfolio_Theory_4_Optimal_Asset_Allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L09_Review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L09: Review</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/L11_RiskReturnTradeoff2_CAMP_MktEfficiency.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Lecture Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 10 11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L10_11: Statistical models of returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L12: CAPM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L13: Cost of equity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L14: Bond pricing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L15: Bond yields</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L16: Bond risk</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 17 Data Processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L17: Valuation data processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 18 and 19 on Multiples Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L18_19: Multiples valuation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 18 Data Processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Valuation overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 19 and 20 on Multiples Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Valuation using multiples: The general approach</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 20 and 21 on DDM Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L20_21: Dividend discount models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 22 and 23 on DCF Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L22_23: Discounted cash flow analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 24 Sensitivity Analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L24: Valuation sensitivity analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 25 Option Intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L25: Options intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 25 Sensitivity Analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The need for sensitivity analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 26 on Option Strategies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L26: Risk management with options</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 26 Option Intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Call options</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture 27 on Option Strategies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Risk management with options</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lecture s 10 and 11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The single-factor model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/lecture01_Introduction_and_Setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L01: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lectures 19 and 20 on Multiples Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Valuation using multiples: The general approach</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lectures 20 and 21 on DDM Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dividend discount models (DDM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lectures 21 and 22 on DDM Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dividend discount models (DDM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lectures 22 and 23 on DCF Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The free cash flow to the firm (FCFF) approach</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../teaching/FIN 421/lectures/Lectures 23 and 24 on DCF Valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The free cash flow to the firm (FCFF) approach</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lecture-overview" id="toc-lecture-overview" class="nav-link active" data-scroll-target="#lecture-overview">Lecture overview</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a></li>
  <li><a href="#grouping-your-data-the-.groupby-function" id="toc-grouping-your-data-the-.groupby-function" class="nav-link" data-scroll-target="#grouping-your-data-the-.groupby-function">Grouping your data: the <code>.groupby()</code> function</a></li>
  <li><a href="#the-.apply-and-.transform-methods" id="toc-the-.apply-and-.transform-methods" class="nav-link" data-scroll-target="#the-.apply-and-.transform-methods">The <code>.apply()</code> and <code>.transform()</code> methods</a></li>
  <li><a href="#winsorizing-outliers" id="toc-winsorizing-outliers" class="nav-link" data-scroll-target="#winsorizing-outliers">Winsorizing outliers</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">L13: Conditional stats, outliers</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="lecture-overview" class="level1">
<h1>Lecture overview</h1>
<p>In this lecture we introduce a set of Pandas functions that are very useful in describing subsamples of your data (this is often called “subsample analysis”). Looking at subsamples of your data individually is important because patterns that show up in your overall dataset may look quite different if you limit yourself to a subset of the dataset. This is exemplified in Simpson’s Paradox: https://en.wikipedia.org/wiki/Simpson%27s_paradox.</p>
<p>We finish the lecture with a discussion of the impact of outliers on your descriptive statistics, and a method of mitigating that impact called “windsorization”.</p>
</section>
<section id="preliminaries" class="level1">
<h1>Preliminaries</h1>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_datareader <span class="im">as</span> pdr</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_rows <span class="op">=</span> <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll use data on the Fama-French 5-industry portfolio returns for this lecture:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>raw <span class="op">=</span> pdr.DataReader(name <span class="op">=</span> <span class="st">'5_Industry_Portfolios'</span>, data_source <span class="op">=</span> <span class="st">'famafrench'</span>, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                     start <span class="op">=</span> <span class="st">'2011-01-01'</span>, end <span class="op">=</span> <span class="st">'2020-12-31'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>{0:          Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                      
 2011-01  -1.34   4.20   3.00  -0.71   1.92
 2011-02   2.89   4.87   3.45   3.33   2.63
 2011-03   1.89   1.81  -0.83   2.29  -0.86
 2011-04   4.36   2.58   3.16   6.37   1.11
 2011-05   0.92  -2.55  -1.13   1.96  -2.40
 ...        ...    ...    ...    ...    ...
 2020-08  10.07   3.15  10.00   2.45   7.20
 2020-09  -4.01  -2.24  -4.82  -1.47  -2.98
 2020-10  -2.64  -0.03  -2.02  -4.42  -1.88
 2020-11  11.44  12.91  11.16   9.51  15.76
 2020-12   4.09   2.65   4.99   4.77   5.27
 
 [120 rows x 5 columns],
 1:          Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                      
 2011-01  -0.54   3.64   3.18   1.26   1.88
 2011-02   4.14   5.50   5.49   3.46   2.92
 2011-03   1.15   3.33   0.88   2.77  -0.48
 2011-04   2.32   0.47   1.45   5.02   0.23
 2011-05  -1.00  -3.48  -1.78  -0.18  -2.72
 ...        ...    ...    ...    ...    ...
 2020-08   9.79   3.39   4.02   1.41   5.59
 2020-09  -1.96  -4.15  -2.97  -1.14  -3.47
 2020-10   2.54   0.97   0.23  -2.71   4.03
 2020-11  22.36  23.25  22.36  18.58  18.45
 2020-12   6.13   9.22  11.49   9.74   9.02
 
 [120 rows x 5 columns],
 2:       Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                   
 2011   9.05   4.47   0.49  10.87  -9.89
 2012  16.30   8.81  16.73  20.35  22.27
 2013  32.99  29.18  33.65  41.19  40.86
 2014  12.63   3.38  14.48  24.46  12.34
 2015   6.79 -11.64   3.83   5.80  -1.15
 2016   5.48  20.34  13.98  -1.85  20.17
 2017  18.68  18.17  29.50  22.20  21.52
 2018  -3.58 -11.10  -0.59   4.82  -9.23
 2019  25.88  21.21  41.85  20.20  29.50
 2020  37.64   0.26  42.65  18.31   6.88,
 3:       Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                   
 2011  -6.73  -6.02 -13.44 -10.95 -10.41
 2012  21.99   8.97  10.64  25.44  25.82
 2013  43.72  37.33  50.77  56.15  42.26
 2014   4.87  -8.46   2.41  14.20   7.92
 2015  -9.62 -22.43  -3.48   2.35  -3.05
 2016  16.05  33.62  17.30 -11.21  30.99
 2017   6.42  10.37  25.78  25.49  14.59
 2018 -14.13 -22.04  -6.41 -22.48 -13.87
 2019  17.49  12.04  27.63  25.96  26.27
 2020  42.47  18.60  65.97  63.85  12.45,
 4:          Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                      
 2011-01    613    720    790    457   1182
 2011-02    611    715    783    453   1180
 2011-03    604    711    778    450   1174
 2011-04    600    709    767    445   1162
 2011-05    596    706    761    443   1154
 ...        ...    ...    ...    ...    ...
 2020-08    481    557    633    719   1022
 2020-09    479    554    630    718   1020
 2020-10    479    550    628    712   1013
 2020-11    479    548    627    710   1011
 2020-12    475    548    624    706   1010
 
 [120 rows x 5 columns],
 5:             Cnsmr    Manuf     HiTec    Hlth     Other
 Date                                                  
 2011-01   4021.78  4907.75   4617.97  2797.17  2823.79
 2011-02   3978.53  5133.19   4789.86  2794.87  2880.75
 2011-03   4122.09  5396.87   4968.89  2890.04  2966.86
 2011-04   4213.62  5503.13   4974.81  2936.50  2966.20
 2011-05   4422.42  5657.10   5157.11  3134.23  3012.30
 ...           ...      ...       ...      ...      ...
 2020-08  12344.23  7837.49  19959.78  4733.39  6902.46
 2020-09  13628.75  8094.48  22037.83  4845.20  7402.98
 2020-10  13059.65  7942.45  21034.62  4752.32  7187.19
 2020-11  12707.13  7957.86  20625.15  4534.52  7057.75
 2020-12  14223.39  8951.70  22998.28  4986.10  8166.06
 
 [120 rows x 5 columns],
 6:       Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                   
 2011   0.31   0.41   0.34   0.35   0.67
 2012   0.30   0.47   0.34   0.33   0.74
 2013   0.27   0.44   0.32   0.27   0.62
 2014   0.26   0.38   0.28   0.23   0.55
 2015   0.24   0.44   0.26   0.20   0.54
 2016   0.23   0.41   0.28   0.22   0.60
 2017   0.24   0.38   0.24   0.20   0.48
 2018   0.22   0.38   0.21   0.19   0.46
 2019   0.22   0.41   0.20   0.19   0.46
 2020   0.22   0.48   0.18   0.19   0.57,
 7:       Cnsmr  Manuf  HiTec  Hlth   Other
 Date                                   
 2011   0.32   0.44   0.35   0.39   0.65
 2012   0.32   0.47   0.38   0.36   0.84
 2013   0.31   0.48   0.36   0.32   0.74
 2014   0.27   0.42   0.29   0.25   0.57
 2015   0.24   0.40   0.26   0.21   0.55
 2016   0.24   0.47   0.29   0.22   0.56
 2017   0.24   0.37   0.26   0.23   0.51
 2018   0.21   0.39   0.22   0.20   0.44
 2019   0.24   0.45   0.25   0.21   0.53
 2020   0.20   0.52   0.18   0.19   0.42,
 'DESCR': '5 Industry Portfolios\n---------------------\n\nThis file was created by CMPT_IND_RETS using the 202201 CRSP database. It contains value- and equal-weighted returns for 5 industry portfolios. The portfolios are constructed at the end of June. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2022 Kenneth R. French\n\n  0 : Average Value Weighted Returns -- Monthly (120 rows x 5 cols)\n  1 : Average Equal Weighted Returns -- Monthly (120 rows x 5 cols)\n  2 : Average Value Weighted Returns -- Annual (10 rows x 5 cols)\n  3 : Average Equal Weighted Returns -- Annual (10 rows x 5 cols)\n  4 : Number of Firms in Portfolios (120 rows x 5 cols)\n  5 : Average Firm Size (120 rows x 5 cols)\n  6 : Sum of BE / Sum of ME (10 rows x 5 cols)\n  7 : Value-Weighted Average of BE/ME (10 rows x 5 cols)'}</code></pre>
</div>
</div>
<p>Extract equal-weighted <em>annual</em> industry returns, and turn them to decimal (they are in percentage points):</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ew <span class="op">=</span> raw[<span class="dv">3</span>]<span class="op">/</span><span class="dv">100</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ew</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Cnsmr</th>
<th data-quarto-table-cell-role="th">Manuf</th>
<th data-quarto-table-cell-role="th">HiTec</th>
<th data-quarto-table-cell-role="th">Hlth</th>
<th data-quarto-table-cell-role="th">Other</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2011</td>
<td>-0.0673</td>
<td>-0.0602</td>
<td>-0.1344</td>
<td>-0.1095</td>
<td>-0.1041</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2012</td>
<td>0.2199</td>
<td>0.0897</td>
<td>0.1064</td>
<td>0.2544</td>
<td>0.2582</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013</td>
<td>0.4372</td>
<td>0.3733</td>
<td>0.5077</td>
<td>0.5615</td>
<td>0.4226</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2014</td>
<td>0.0487</td>
<td>-0.0846</td>
<td>0.0241</td>
<td>0.1420</td>
<td>0.0792</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015</td>
<td>-0.0962</td>
<td>-0.2243</td>
<td>-0.0348</td>
<td>0.0235</td>
<td>-0.0305</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016</td>
<td>0.1605</td>
<td>0.3362</td>
<td>0.1730</td>
<td>-0.1121</td>
<td>0.3099</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017</td>
<td>0.0642</td>
<td>0.1037</td>
<td>0.2578</td>
<td>0.2549</td>
<td>0.1459</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2018</td>
<td>-0.1413</td>
<td>-0.2204</td>
<td>-0.0641</td>
<td>-0.2248</td>
<td>-0.1387</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019</td>
<td>0.1749</td>
<td>0.1204</td>
<td>0.2763</td>
<td>0.2596</td>
<td>0.2627</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2020</td>
<td>0.4247</td>
<td>0.1860</td>
<td>0.6597</td>
<td>0.6385</td>
<td>0.1245</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s take a look at the data:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ew.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture13_wins_groupby_apply_transform_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Calculate cumulative products of gross returns (i.e.&nbsp;compound returns over time) and plot them:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="op">+</span>ew).cumprod().plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="lecture13_wins_groupby_apply_transform_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Stack industry returns on top of each other for the purpose of this class:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ew_long <span class="op">=</span> ew.stack().to_frame(name <span class="op">=</span> <span class="st">'ewret'</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ew_long.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2011</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>-0.0673</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>-0.0602</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>-0.1344</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>-0.1095</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>-0.1041</td>
</tr>
<tr class="even">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2012</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>0.2199</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>0.0897</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>0.1064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>0.2544</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Other</td>
<td>0.2582</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And bring date and industry names as data inside the dataframe:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ew_long <span class="op">=</span> ew_long.reset_index().rename(columns <span class="op">=</span> {<span class="st">'level_1'</span>:<span class="st">'Industry'</span>})</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ew_long.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2011</td>
<td>Cnsmr</td>
<td>-0.0673</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2011</td>
<td>Manuf</td>
<td>-0.0602</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Challenge:</strong></p>
<p>Do the same for value-weighted annual returns (i.e.&nbsp;create a “vw_long” dataframe, using the same steps we used for “ew_long”:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>vw <span class="op">=</span> raw[<span class="dv">2</span>]<span class="op">/</span><span class="dv">100</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>vw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Cnsmr</th>
<th data-quarto-table-cell-role="th">Manuf</th>
<th data-quarto-table-cell-role="th">HiTec</th>
<th data-quarto-table-cell-role="th">Hlth</th>
<th data-quarto-table-cell-role="th">Other</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2011</td>
<td>0.0905</td>
<td>0.0447</td>
<td>0.0049</td>
<td>0.1087</td>
<td>-0.0989</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2012</td>
<td>0.1630</td>
<td>0.0881</td>
<td>0.1673</td>
<td>0.2035</td>
<td>0.2227</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013</td>
<td>0.3299</td>
<td>0.2918</td>
<td>0.3365</td>
<td>0.4119</td>
<td>0.4086</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2014</td>
<td>0.1263</td>
<td>0.0338</td>
<td>0.1448</td>
<td>0.2446</td>
<td>0.1234</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015</td>
<td>0.0679</td>
<td>-0.1164</td>
<td>0.0383</td>
<td>0.0580</td>
<td>-0.0115</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016</td>
<td>0.0548</td>
<td>0.2034</td>
<td>0.1398</td>
<td>-0.0185</td>
<td>0.2017</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017</td>
<td>0.1868</td>
<td>0.1817</td>
<td>0.2950</td>
<td>0.2220</td>
<td>0.2152</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2018</td>
<td>-0.0358</td>
<td>-0.1110</td>
<td>-0.0059</td>
<td>0.0482</td>
<td>-0.0923</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019</td>
<td>0.2588</td>
<td>0.2121</td>
<td>0.4185</td>
<td>0.2020</td>
<td>0.2950</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2020</td>
<td>0.3764</td>
<td>0.0026</td>
<td>0.4265</td>
<td>0.1831</td>
<td>0.0688</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>vw_long <span class="op">=</span> vw.stack().to_frame(name <span class="op">=</span> <span class="st">'vwret'</span>)<span class="op">\</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>            .reset_index().rename(columns<span class="op">=</span>{<span class="st">'level_1'</span>:<span class="st">'Industry'</span>})</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>vw_long.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2011</td>
<td>Cnsmr</td>
<td>0.0905</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2011</td>
<td>Manuf</td>
<td>0.0447</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2011</td>
<td>HiTec</td>
<td>0.0049</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2011</td>
<td>Hlth</td>
<td>0.1087</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2011</td>
<td>Other</td>
<td>-0.0989</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Merge the EW returns and VW returns into a single dataframe called “ireturns”:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ireturns <span class="op">=</span> ew_long.merge(vw_long, how<span class="op">=</span><span class="st">'inner'</span>, on <span class="op">=</span> [<span class="st">'Date'</span>,<span class="st">'Industry'</span>])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ireturns.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2011</td>
<td>Cnsmr</td>
<td>-0.0673</td>
<td>0.0905</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2011</td>
<td>Manuf</td>
<td>-0.0602</td>
<td>0.0447</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2011</td>
<td>HiTec</td>
<td>-0.1344</td>
<td>0.0049</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2011</td>
<td>Hlth</td>
<td>-0.1095</td>
<td>0.1087</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2011</td>
<td>Other</td>
<td>-0.1041</td>
<td>-0.0989</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2012</td>
<td>Cnsmr</td>
<td>0.2199</td>
<td>0.1630</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2012</td>
<td>Manuf</td>
<td>0.0897</td>
<td>0.0881</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2012</td>
<td>HiTec</td>
<td>0.1064</td>
<td>0.1673</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2012</td>
<td>Hlth</td>
<td>0.2544</td>
<td>0.2035</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2012</td>
<td>Other</td>
<td>0.2582</td>
<td>0.2227</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="grouping-your-data-the-.groupby-function" class="level1">
<h1>Grouping your data: the <code>.groupby()</code> function</h1>
<p>The <code>.groupby()</code> function can be used to tell Python that you want to split your data into groups. The parameters of the <code>.groupby()</code> function tell Python <em>how</em> those groups should be created. The purpose is usually to apply some function (e.g.&nbsp;the “.mean()” function) to each of these groups separately.</p>
<p>Abbreviated syntax:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>DataFrame.groupby(by<span class="op">=</span><span class="va">None</span>, axis<span class="op">=</span><span class="dv">0</span>, level<span class="op">=</span><span class="va">None</span>, as_index<span class="op">=</span><span class="va">True</span>, sort<span class="op">=</span><span class="va">True</span>, dropna<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The most important parameter is <code>by</code>. This is where you tell Python which column (or index) in your DataFrame contains the information based on which you want to group your data. Python will split your DataFrame into “mini” dataframes, one for each unique value of the variable(s) you supplied to the <code>by</code> parameter.</p>
<p>For example, the line below splits <code>ireturns</code> into 5 different dataframes, one for each unique entry found in the “Industry” column, and then applies the <code>.mean()</code> function for each of these 5 dataframes separately. Finally, these subsample means are all collected into a new dataframe <code>ind_means</code>:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ind_means <span class="op">=</span> ireturns.groupby(by <span class="op">=</span> <span class="st">'Industry'</span>).mean()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ind_means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>0.12253</td>
<td>0.16186</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>0.17717</td>
<td>0.19657</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>0.16880</td>
<td>0.16635</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>0.06198</td>
<td>0.08308</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>0.13297</td>
<td>0.13327</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>If you don’t want the <code>by</code> variable (i.e.&nbsp;“Industry” in the example above) to be the index of the resulting dataframe:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ind_means <span class="op">=</span> ireturns.groupby(by <span class="op">=</span> <span class="st">'Industry'</span>, as_index <span class="op">=</span> <span class="va">False</span>).mean()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ind_means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Cnsmr</td>
<td>0.12253</td>
<td>0.16186</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>HiTec</td>
<td>0.17717</td>
<td>0.19657</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Hlth</td>
<td>0.16880</td>
<td>0.16635</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Manuf</td>
<td>0.06198</td>
<td>0.08308</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Other</td>
<td>0.13297</td>
<td>0.13327</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Another example, with a different <code>by</code> variable and a different function applied to each group (i.e.&nbsp;median instead of mean):</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>an_means <span class="op">=</span> ireturns.groupby(by <span class="op">=</span> <span class="st">'Date'</span>).median()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>an_means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2011</td>
<td>-0.1041</td>
<td>0.0447</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2012</td>
<td>0.2199</td>
<td>0.1673</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013</td>
<td>0.4372</td>
<td>0.3365</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2014</td>
<td>0.0487</td>
<td>0.1263</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015</td>
<td>-0.0348</td>
<td>0.0383</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016</td>
<td>0.1730</td>
<td>0.1398</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017</td>
<td>0.1459</td>
<td>0.2152</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2018</td>
<td>-0.1413</td>
<td>-0.0358</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019</td>
<td>0.2596</td>
<td>0.2588</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2020</td>
<td>0.4247</td>
<td>0.1831</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can group by more than one variable:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>twodim <span class="op">=</span> ireturns.groupby(by <span class="op">=</span> [<span class="st">'Date'</span>,<span class="st">'Industry'</span>]).mean()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>twodim.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2011</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>-0.0673</td>
<td>0.0905</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>-0.1344</td>
<td>0.0049</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>-0.1095</td>
<td>0.1087</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>-0.0602</td>
<td>0.0447</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>-0.1041</td>
<td>-0.0989</td>
</tr>
<tr class="even">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2012</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>0.2199</td>
<td>0.1630</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>0.1064</td>
<td>0.1673</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>0.2544</td>
<td>0.2035</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>0.0897</td>
<td>0.0881</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Other</td>
<td>0.2582</td>
<td>0.2227</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The example above did not really change the <code>ireturns</code> dataframe, since each “Date” x “Industry” pair has a single entry for both “ewret” and “vwret”. Since the mean of a single number is the number itself, the <code>twodim</code> dataframe will be identical to <code>ireturns</code>. Note that this is not necessarily the case if we used a different function instead of <code>.mean()</code>, for example <code>.count()</code>:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>twodim <span class="op">=</span> ireturns.groupby(by <span class="op">=</span> [<span class="st">'Date'</span>,<span class="st">'Industry'</span>]).count()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>twodim.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2011</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2012</td>
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Other</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>You can specify which variable(s) you want to apply the function to, in brackets, right before the function name (if you leave this out (like above), the function will be applied to all the columns in the dataframe):</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ind_ew_medians <span class="op">=</span> ireturns.groupby(<span class="st">'Industry'</span>)[<span class="st">'ewret'</span>].median()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ind_ew_medians</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Industry
Cnsmr    0.11235
HiTec    0.13970
Hlth     0.19820
Manuf    0.09670
Other    0.13520
Name: ewret, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="the-.apply-and-.transform-methods" class="level1">
<h1>The <code>.apply()</code> and <code>.transform()</code> methods</h1>
<p>The <code>.apply()</code> and <code>.transform()</code> methods do similar things: they can be used to tell Python to apply a given function to some data from a dataframe. As the examples above show, there are many Pandas functions, like <code>.mean()</code> and <code>.median()</code> that can do this without the help of <code>.apply()</code> or <code>.transform()</code> (we just have to add the names of these functions after the <code>.groupby()</code> statement, just like we did above). But what if the function we want to apply is not a built-in Pandas function that can be applied with a dot after the name of a dataframe? This is where <code>.apply()</code> and <code>.transform()</code> come in handy. These methods are especially useful when we want to apply a particular function, separately, to each group we created with a <code>.groupby</code> statement.</p>
<p>Here is their syntax:</p>
<p>Syntax for <code>.transform()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>DataFrame.transform(func, axis<span class="op">=</span><span class="dv">0</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Syntax for <code>.apply()</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>DataFrame.<span class="bu">apply</span>(func, axis<span class="op">=</span><span class="dv">0</span>, raw<span class="op">=</span><span class="va">False</span>, result_type<span class="op">=</span><span class="va">None</span>, args<span class="op">=</span>(), <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The most important argument is <code>func</code> which is where we tell Python which function we want to apply to the data.</p>
<p>The main difference between <code>.transform()</code> and <code>.apply()</code> is that <code>.transform()</code> returns a sequence of the same length as the dataframe to which it is applied, while <code>.apply()</code> returns a DataFrame or Series of the same size as the number of groups to which it is applied.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ireturns.groupby(<span class="st">'Industry'</span>)[<span class="st">'ewret'</span>].<span class="bu">apply</span>(func <span class="op">=</span> np.median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>Industry
Cnsmr    0.11235
HiTec    0.13970
Hlth     0.19820
Manuf    0.09670
Other    0.13520
Name: ewret, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ireturns.groupby(<span class="st">'Industry'</span>)[<span class="st">'ewret'</span>].transform(func <span class="op">=</span> np.median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>0     0.11235
1     0.09670
2     0.13970
3     0.19820
4     0.13520
       ...   
45    0.11235
46    0.09670
47    0.13970
48    0.19820
49    0.13520
Name: ewret, Length: 50, dtype: float64</code></pre>
</div>
</div>
<p>We usually add the results of <code>.transform()</code> as a new column to the same dataframe:</p>
<div class="cell" data-scrolled="true" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>mycopy <span class="op">=</span> ireturns.copy()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>mycopy[<span class="st">'ind_medians'</span>] <span class="op">=</span> mycopy.groupby(<span class="st">'Industry'</span>)[<span class="st">'ewret'</span>].transform(np.median)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>mycopy.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
<th data-quarto-table-cell-role="th">ind_medians</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2011</td>
<td>Cnsmr</td>
<td>-0.0673</td>
<td>0.0905</td>
<td>0.11235</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2011</td>
<td>Manuf</td>
<td>-0.0602</td>
<td>0.0447</td>
<td>0.09670</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2011</td>
<td>HiTec</td>
<td>-0.1344</td>
<td>0.0049</td>
<td>0.13970</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2011</td>
<td>Hlth</td>
<td>-0.1095</td>
<td>0.1087</td>
<td>0.19820</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2011</td>
<td>Other</td>
<td>-0.1041</td>
<td>-0.0989</td>
<td>0.13520</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2012</td>
<td>Cnsmr</td>
<td>0.2199</td>
<td>0.1630</td>
<td>0.11235</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2012</td>
<td>Manuf</td>
<td>0.0897</td>
<td>0.0881</td>
<td>0.09670</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2012</td>
<td>HiTec</td>
<td>0.1064</td>
<td>0.1673</td>
<td>0.13970</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2012</td>
<td>Hlth</td>
<td>0.2544</td>
<td>0.2035</td>
<td>0.19820</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2012</td>
<td>Other</td>
<td>0.2582</td>
<td>0.2227</td>
<td>0.13520</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Note, also, that with <code>.transform()</code>, you can pass the name of the function you want as a <strong>string</strong> to the <code>func</code> argument, whereas with <code>.apply()</code> you can not:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ireturns.groupby(<span class="st">'Industry'</span>)[[<span class="st">'ewret'</span>,<span class="st">'vwret'</span>]].transform(<span class="st">'median'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.11235</td>
<td>0.14465</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.09670</td>
<td>0.06640</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.13970</td>
<td>0.15605</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.19820</td>
<td>0.19255</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.13520</td>
<td>0.16255</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">45</td>
<td>0.11235</td>
<td>0.14465</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">46</td>
<td>0.09670</td>
<td>0.06640</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>0.13970</td>
<td>0.15605</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>0.19820</td>
<td>0.19255</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">49</td>
<td>0.13520</td>
<td>0.16255</td>
</tr>
</tbody>
</table>

<p>50 rows × 2 columns</p>
</div>
</div>
</div>
<p>Whereas the line below will not work. You have to specify which package the “median” function belongs to (which is why we used <code>.apply(np.median)</code> above):</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ireturns.groupby('Industry')[['ewret','vwret']].apply('median') #this gives an error</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are not restricted to applying functions that come with a package that we have installed. We can also use a function that we created ourselves.</p>
<p>For example, below, we create a function that can take in a Series or a DataFrame of returns, and compounds them:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compound_returns(x):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span><span class="op">+</span>x).prod()<span class="op">-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can apply that function to the returns of each industry:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ireturns.groupby(<span class="st">'Industry'</span>)[[<span class="st">'ewret'</span>,<span class="st">'vwret'</span>]].<span class="bu">apply</span>(compound_returns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">vwret</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Cnsmr</td>
<td>1.751321</td>
<td>3.242533</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HiTec</td>
<td>3.174702</td>
<td>4.532945</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Hlth</td>
<td>2.634393</td>
<td>3.435179</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Manuf</td>
<td>0.525684</td>
<td>1.060787</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Other</td>
<td>2.079929</td>
<td>2.161870</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s see if it worked:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="op">+</span>ew).cumprod()<span class="op">-</span><span class="dv">1</span> <span class="co">#look at the bottom row and compare it with our results above</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Cnsmr</th>
<th data-quarto-table-cell-role="th">Manuf</th>
<th data-quarto-table-cell-role="th">HiTec</th>
<th data-quarto-table-cell-role="th">Hlth</th>
<th data-quarto-table-cell-role="th">Other</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2011</td>
<td>-0.067300</td>
<td>-0.060200</td>
<td>-0.134400</td>
<td>-0.109500</td>
<td>-0.104100</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2012</td>
<td>0.137801</td>
<td>0.024100</td>
<td>-0.042300</td>
<td>0.117043</td>
<td>0.127221</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013</td>
<td>0.635247</td>
<td>0.406397</td>
<td>0.443924</td>
<td>0.744263</td>
<td>0.603585</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2014</td>
<td>0.714884</td>
<td>0.287415</td>
<td>0.478723</td>
<td>0.991948</td>
<td>0.730589</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015</td>
<td>0.549912</td>
<td>-0.001352</td>
<td>0.427263</td>
<td>1.038759</td>
<td>0.677806</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2016</td>
<td>0.798673</td>
<td>0.334394</td>
<td>0.674180</td>
<td>0.810214</td>
<td>1.197758</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2017</td>
<td>0.914148</td>
<td>0.472770</td>
<td>1.105783</td>
<td>1.271638</td>
<td>1.518411</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2018</td>
<td>0.643679</td>
<td>0.148172</td>
<td>0.970802</td>
<td>0.760974</td>
<td>1.169108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019</td>
<td>0.931158</td>
<td>0.286412</td>
<td>1.515335</td>
<td>1.218122</td>
<td>1.738932</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2020</td>
<td>1.751321</td>
<td>0.525684</td>
<td>3.174702</td>
<td>2.634393</td>
<td>2.079929</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="winsorizing-outliers" class="level1">
<h1>Winsorizing outliers</h1>
<p>“Winsorizing” a variable means replacing its most extreme values with less extreme values. For example, winsorizing a variable “at the 5 and 95 percentiles”, means that the values of that variable that are smaller than the 5th percentile will be made equal to the 5th percentile and the values that are larger than the 95th percentile will be made equal to the 95th percentile.</p>
<p>You can pick other values for the percentiles at which you want to winsorize but (1,99) and (5, 95) are by far the most common ones.</p>
<p>To winsorize a variable, in a Pandas dataframe, we use the <code>.clip()</code> function as below. This also requires us to use the <code>.quantile()</code> function to calculate the 5th and 95th percentiles. First, let’s sort the returns so we can easily see its most extreme values (top and bottom):</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ew_long.sort_values(<span class="st">'ewret'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>2018</td>
<td>Hlth</td>
<td>-0.2248</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>2015</td>
<td>Manuf</td>
<td>-0.2243</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>2018</td>
<td>Manuf</td>
<td>-0.2204</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>2018</td>
<td>Cnsmr</td>
<td>-0.1413</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">39</td>
<td>2018</td>
<td>Other</td>
<td>-0.1387</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2013</td>
<td>Cnsmr</td>
<td>0.4372</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>2013</td>
<td>HiTec</td>
<td>0.5077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>2013</td>
<td>Hlth</td>
<td>0.5615</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>2020</td>
<td>Hlth</td>
<td>0.6385</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>2020</td>
<td>HiTec</td>
<td>0.6597</td>
</tr>
</tbody>
</table>

<p>50 rows × 3 columns</p>
</div>
</div>
</div>
<p>Let’s calculate the 5th and 95th percentiles:</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>q5 <span class="op">=</span> ew_long[<span class="st">'ewret'</span>].quantile(<span class="fl">0.05</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>q5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>-0.184805</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>q95 <span class="op">=</span> ew_long[<span class="st">'ewret'</span>].quantile(<span class="fl">0.95</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>q95</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.5372899999999998</code></pre>
</div>
</div>
<p>And now let’s create a version of <code>ewret</code> that is winsorized at the 5 and 95 percentiles:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ew_long[<span class="st">'ew_wins'</span>] <span class="op">=</span> ew_long[<span class="st">'ewret'</span>].clip(lower <span class="op">=</span> q5, upper <span class="op">=</span> q95)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see if it worked:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>ew_long.sort_values(<span class="st">'ewret'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">ewret</th>
<th data-quarto-table-cell-role="th">ew_wins</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>2018</td>
<td>Hlth</td>
<td>-0.2248</td>
<td>-0.184805</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>2015</td>
<td>Manuf</td>
<td>-0.2243</td>
<td>-0.184805</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>2018</td>
<td>Manuf</td>
<td>-0.2204</td>
<td>-0.184805</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>2018</td>
<td>Cnsmr</td>
<td>-0.1413</td>
<td>-0.141300</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">39</td>
<td>2018</td>
<td>Other</td>
<td>-0.1387</td>
<td>-0.138700</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2013</td>
<td>Cnsmr</td>
<td>0.4372</td>
<td>0.437200</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>2013</td>
<td>HiTec</td>
<td>0.5077</td>
<td>0.507700</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>2013</td>
<td>Hlth</td>
<td>0.5615</td>
<td>0.537290</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>2020</td>
<td>Hlth</td>
<td>0.6385</td>
<td>0.537290</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">47</td>
<td>2020</td>
<td>HiTec</td>
<td>0.6597</td>
<td>0.537290</td>
</tr>
</tbody>
</table>

<p>50 rows × 4 columns</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/github\.com\/ionmihai\/ionmihai\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>